name: Playwright â†’ RTM for Jira 2 

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test-and-report:
    runs-on: ubuntu-latest
    env:
      JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
      JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies and Playwright browsers
        run: |
          npm ci
          npx playwright install --with-deps

      - name: Run Playwright with JSON reporter
        run: |
            reporter:[['json', { outputFile:'test-artifacts/test-reporter.json' }], ['list']],

      - name: Ensure jq and curl are available
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Create RTM Test Execution
        id: create_te
        shell: bash
        run: |
          BASIC=$(printf "%s:%s" "$JIRA_EMAIL" "$JIRA_API_TOKEN" | base64 -w 0)
          body=$(jq -n --arg projectKey "$JIRA_PROJECT_KEY" \
                     --arg name "Playwright Run - ${GITHUB_RUN_NUMBER}" \
                     --arg desc "CI run ${GITHUB_RUN_ID} on ${GITHUB_REF} (commit ${GITHUB_SHA})" \
                     '{projectKey:$projectKey, name:$name, description:$desc}')
          resp=$(curl -sS -X POST "$JIRA_BASE_URL/rest/rtm/latest/testexecution" \
                   -H "Authorization: Basic $BASIC" \
                   -H "Content-Type: application/json" \
                   -d "$body")
          echo "$resp" | tee te.json
          TE_KEY=$(jq -r '.key // empty' te.json)
          if [ -z "$TE_KEY" ]; then
            echo "Failed to create Test Execution. Response:"
            cat te.json
            exit 1
          fi
          echo "TE_KEY=$TE_KEY" >> $GITHUB_ENV

      - name: Upload Playwright artifacts to the Test Execution (optional)
        if: env.TE_KEY != ''
        shell: bash
        run: |
          BASIC=$(printf "%s:%s" "$JIRA_EMAIL" "$JIRA_API_TOKEN" | base64 -w 0)
          # Upload JSON report
          curl -sS -X POST "$JIRA_BASE_URL/rest/api/2/issue/$TE_KEY/attachments" \
            -H "Authorization: Basic $BASIC" \
            -H "X-Atlassian-Token: no-check" \
            -F "file=@test-reporter.json,type=application/json" || true
          # Upload screenshots/videos if present
          shopt -s nullglob
          files=(test-artifacts/**/*)
          for f in "${files[@]}"; do
            [ -f "$f" ] || continue
            curl -sS -X POST "$JIRA_BASE_URL/rest/api/2/issue/$TE_KEY/attachments" \
              -H "Authorization: Basic $BASIC" \
              -H "X-Atlassian-Token: no-check" \
              -F "file=@${f}" || true
          done

      - name: Report Test Case Executions to RTM
        if: env.TE_KEY != ''
        shell: bash
        run: |
          BASIC=$(printf "%s:%s" "$JIRA_EMAIL" "$JIRA_API_TOKEN" | base64 -w 0)

          # Parse Playwright JSON and post results to RTM.
          # Expect @TC=KEY (e.g., @TC=WEB-TC-123) in test titles.
          jq -r '
            def statusMap($s):
              if $s=="passed" then "PASSED"
              elif $s=="failed" then "FAILED"
              elif $s=="skipped" or $s=="timedOut" then "BLOCKED"
              else "TODO" end;

            .suites[]? as $s |
            $s.specs[]? as $sp |
            $sp.tests[]? as $t |
            {
              title: ($t.title // ""),
              status: (statusMap(($t.results[0]?.status // "unknown"))),
              comment: (
                ($t.results[]? | select(.status=="failed") | .error?.message) // ""
              )
            } | @base64
          ' test-reporter.json | while read -r row; do
            obj=$(echo "$row" | base64 --decode)
            TITLE=$(echo "$obj" | jq -r '.title')
            STATUS=$(echo "$obj" | jq -r '.status')
            COMMENT=$(echo "$obj" | jq -r '.comment')

            if [[ "$TITLE" =~ @TC=([A-Z0-9][A-Z0-9_-]*-[A-Z0-9_-]+) ]]; then
              TC_KEY="${BASH_REMATCH[1]}"
            else
              echo "Skipping test without @TC=KEY tag: $TITLE"
              continue
            fi

            payload=$(jq -n --arg tc "$TC_KEY" --arg te "$TE_KEY" --arg st "$STATUS" --arg cm "$COMMENT" \
                        '{testCaseKey:$tc, testExecutionKey:$te, status:$st, comment:$cm}')

            echo "Posting result: $TC_KEY -> $STATUS"
            curl -sS -o /dev/null -w "%{http_code}\n" \
              -X POST "$JIRA_BASE_URL/rest/rtm/latest/testcaseexecution" \
              -H "Authorization: Basic $BASIC" \
              -H "Content-Type: application/json" \
              -d "$payload" | {
                read code
                if [ "$code" != "200" ] && [ "$code" != "201" ]; then
                  echo "Failed to post result for $TC_KEY (HTTP $code)"
                fi
              }
          done

      - name: Upload job outputs
        uses: actions/upload-artifact@v4
        with:
          name: rtm-${{ env.TE_KEY }}
          path: |
            te.json
            test-reporter.json
          if-no-files-found: warn