name: Playwright Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # 1. Checkout repo
      - uses: actions/checkout@v5

      # 2. Node setup
      - uses: actions/setup-node@v5
        with:
          node-version: lts/*

      # 3. Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4. Install Playwright browsers
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # 5. Run Playwright tests
      - name: Run Playwright tests
        id: tests
        continue-on-error: true
        run: |
          echo "Running Playwright tests..."
          npx playwright test
          echo "EXIT_CODE=$?" >> $GITHUB_ENV

      # 6. Upload HTML test report
      - name: Upload Playwright HTML report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/

      # 7. Post comment to Jira RTM Test Execution
      - name: Comment results on Jira Test Execution
        if: ${{ always() }}
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          TEST_EXEC_KEY: "RTM-ECS"  # <-- REPLACE WITH YOUR TEST EXECUTION KEY
          STATUS: ${{ env.EXIT_CODE }}
        run: |
          if [ "$STATUS" -eq 0 ]; then
            RESULT="PASSED"
          else
            RESULT="FAILED"
          fi

          COMMENT="Automated Playwright Execution Result: *$RESULT*%0A
          Workflow: $GITHUB_WORKFLOW%0A
          Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}%0A
          HTML Report: (download the 'playwright-report' artifact)%0A
          Commit: ${{ github.sha }}%0A
          Branch: ${{ github.ref }}%0A
          Timestamp: $(date -u)"

          curl -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            -H "Content-Type: application/json" \
            -X POST \
            --data "{\"body\": \"$COMMENT\"}" \
            "$JIRA_BASE_URL/rest/api/2/issue/$TEST_EXEC_KEY/comment"
