name: Playwright + RTM Import

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # Checkout project
      - name: Checkout
        uses: actions/checkout@v4

      # Set up Node
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # Install deps + Playwright
      - name: Install dependencies
        run: |
          npm ci
          npx playwright install --with-deps

      # Run Playwright with JUnit reporter
      - name: Run Playwright tests
        run: |
          npx playwright test --reporter=junit,html
        env:
          CI: true

      # Create ZIP archive with XMLs for RTM import
      - name: Archive JUnit results
        run: |
          ls -la
          find ./tests -name "*.xml" -type f
          cp ./tests/*.xml rtm-archive/ || echo "No XML files found"
          mkdir -p rtm-archive
          cp *.xml rtm-archive/ 2>/dev/null || echo "No XML files in root"
          cd rtm-archive
          zip -r ../rtm-results.zip .
          echo "Archive created:"
          ls -lh ../rtm-results.zip

      # Upload to Deviniti RTM
      - name: Upload test results to RTM
        run: |
          echo "Uploading results to RTMâ€¦"

          curl -X POST "https://rtm-eu-api.hexygen.com/api/v2/automation/import-test-results" \
            -H "Authorization: Bearer $RTM_API_TOKEN" \
            -F "projectKey=$RTM_PROJECT_KEY" \
            -F "file=@rtm-results.zip" \
            -F "reportType=JUNIT" \
            -F "name=Playwright Results $(date +'%Y-%m-%d %H:%M')" \
            -F 'treePath=/Automatic/e2e/moduleA'\
            -F "jobUrl=$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"\
            -F 'testExecutionFields={ "fields": {"labels" : ["e2etest"]} }' \
            -F 'testCaseFields={"fields": {"labels": ["automated", "regression"]}}'

        env:
          RTM_BASE_URL: https://rtm-eu-api.hexygen.com/api
          RTM_API_TOKEN: eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiI0OTIyNTkifQ.7Ne6V2Kn5t-KC-FLAWhMEH5xme1qSRCnH3OMT8x_6Ec1859lb1vgjDL8dIzaure7
          RTM_PROJECT_KEY: ECS
